{"version":3,"file":"ContextThrottleService.js","sourceRoot":"","sources":["../../src/services/ContextThrottleService.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventBus } from './EventBus';\nimport { TransactionExecutor } from './TransactionExecutor';\n\ninterface ContextThrottleInfo<T = unknown> {\n  prevValue: T | null;\n  updateTimerId: number;\n  throttledValue: T;\n  lastUpdateTimestamp: number;\n}\n\ninterface ContextThrottleServiceSettings {\n  interval: number;\n  throttled: boolean;\n}\n\nexport class ContextThrottleService {\n  private static instance?: ContextThrottleService;\n  private interval = 0;\n  private throttled = true;\n  private contextThrottleMap: Map<string, ContextThrottleInfo> = new Map();\n\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\n  private constructor() {}\n\n  public static getInstance() {\n    if (!ContextThrottleService.instance) {\n      ContextThrottleService.instance = new ContextThrottleService();\n    }\n\n    return ContextThrottleService.instance;\n  }\n\n  private getWithInitThrottleInfoByName<T>(\n    contextName: string,\n    contextValue: T,\n  ): ContextThrottleInfo<T> {\n    if (!this.contextThrottleMap.has(contextName)) {\n      const contextData = {\n        prevValue: null,\n        throttledValue: contextValue,\n        lastUpdateTimestamp: 0,\n        updateTimerId: 0,\n      };\n\n      this.contextThrottleMap.set(contextName, contextData);\n    }\n\n    return this.contextThrottleMap.get(contextName) as ContextThrottleInfo<T>;\n  }\n\n  private getTimeUntilNextUpdate(lastUpdateTimestamp: number) {\n    const timeSinceLastUpdate = Date.now() - lastUpdateTimestamp;\n    const delayUntilNextUpdate = this.interval - timeSinceLastUpdate;\n    return delayUntilNextUpdate;\n  }\n\n  private updateContextValue<T>(contextName: string, newValue: T) {\n    const contextData = this.getWithInitThrottleInfoByName(contextName, newValue);\n\n    if (newValue === contextData.throttledValue) {\n      return;\n    }\n\n    contextData.prevValue = contextData.throttledValue;\n    contextData.lastUpdateTimestamp = Date.now();\n    contextData.throttledValue = newValue;\n    EventBus.broadcast(contextName, [contextData.throttledValue, contextData.prevValue]);\n  }\n\n  private throttleUpdateContextValue<T>(contextName: string, newValue: T) {\n    const contextData = this.getWithInitThrottleInfoByName(contextName, newValue);\n    clearTimeout(contextData.updateTimerId);\n\n    if (TransactionExecutor.isRunSyncActive) {\n      return;\n    }\n\n    const lastUpdateTimestamp = contextData.lastUpdateTimestamp;\n    const timeUntilNextUpdate = this.getTimeUntilNextUpdate(lastUpdateTimestamp);\n\n    if (timeUntilNextUpdate <= 0) {\n      this.updateContextValue(contextName, newValue);\n    } else {\n      contextData.updateTimerId = setTimeout(() => {\n        this.updateContextValue(contextName, newValue);\n      }, timeUntilNextUpdate);\n    }\n  }\n\n  public static triggerContextUpdate<T>(contextName: string, newValue: T) {\n    const throttledService = ContextThrottleService.getInstance();\n    const contextData = throttledService.getWithInitThrottleInfoByName(contextName, newValue);\n\n    if (newValue === contextData.throttledValue) {\n      return;\n    }\n\n    if (!throttledService.throttled && !TransactionExecutor.isRunSyncActive) {\n      throttledService.updateContextValue(contextName, newValue);\n    } else {\n      throttledService.throttleUpdateContextValue(contextName, newValue);\n    }\n  }\n\n  public static retrieveContextInfo<T>(contextName: string, contextValue: T) {\n    const throttledService = ContextThrottleService.getInstance();\n    const { prevValue, throttledValue } = throttledService.getWithInitThrottleInfoByName(\n      contextName,\n      contextValue,\n    );\n\n    return { prevValue, throttledValue };\n  }\n\n  public static updateThrottledServiceSettings(settings: ContextThrottleServiceSettings) {\n    const throttledService = ContextThrottleService.getInstance();\n    throttledService.interval = settings.interval;\n    throttledService.throttled = settings.throttled;\n  }\n}\n"]}